<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Kalman Filter · AlgebraicInference.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">AlgebraicInference.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">AlgebraicInference.jl</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../regression/">Linear Regression</a></li><li class="is-active"><a class="tocitem" href>Kalman Filter</a></li></ul></li><li><a class="tocitem" href="../../api/">Library Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Kalman Filter</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Kalman Filter</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/samuelsonric/AlgebraicInference.jl/blob/master/docs/literate/kalman.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Kalman-Filter"><a class="docs-heading-anchor" href="#Kalman-Filter">Kalman Filter</a><a id="Kalman-Filter-1"></a><a class="docs-heading-anchor-permalink" href="#Kalman-Filter" title="Permalink"></a></h1><pre><code class="language-julia hljs">using AlgebraicInference
using BenchmarkTools
using Catlab.Graphics, Catlab.Programs, Catlab.WiringDiagrams
using Distributions
using FillArrays
using LinearAlgebra
using Random</code></pre><p>A Kalman filter with <span>$n$</span> steps is a probability distribution over states <span>$(s_1, \dots, s_n)$</span> and measurements <span>$(z_1, \dots, z_n)$</span> determined by the equations</p><p class="math-container">\[    s_{i+1} \mid s_i \sim \mathcal{N}(As_i, P)\]</p><p>and</p><p class="math-container">\[    z_i \mid s_i \sim \mathcal{N}(Bs_i, Q).\]</p><pre><code class="language-julia hljs">θ = π / 15

A = [
    cos(θ) -sin(θ)
    sin(θ) cos(θ)
]

B = [
    1.3 0.0
    0.0 0.7
]

P = [
    0.05 0.0
    0.0 0.05
]

Q = [
    10.0 0.0
    0.0 10.0
]

function generate_data(n; seed=42)
    Random.seed!(seed)
    x = zeros(2)
    data = Vector{Float64}[]

    for i in 1:n
        x = rand(MvNormal(A * x, P))
        push!(data, rand(MvNormal(B * x, Q)))
    end

    data
end;</code></pre><p>The <em>filtering problem</em> involves predicting the value of the state <span>$s_n$</span> given observations of <span>$(z_1, \dots, z_n)$</span>. The function <code>kalman</code> constructs a wiring diagram that represents the filtering problem.</p><pre><code class="language-julia hljs">function kalman_step(i)
    kf = HypergraphDiagram{String, String}([&quot;X&quot;])
    add_box!(kf, [&quot;X&quot;]; name=&quot;state&quot;)
    add_box!(kf, [&quot;X&quot;, &quot;X&quot;]; name=&quot;predict&quot;)
    add_box!(kf, [&quot;X&quot;, &quot;Z&quot;]; name=&quot;measure&quot;)
    add_box!(kf, [&quot;Z&quot;]; name=&quot;z$i&quot;)

    add_wires!(kf, [
        (0, 1) =&gt; (2, 2),
        (1, 1) =&gt; (2, 1),
        (1, 1) =&gt; (3, 1),
        (3, 2) =&gt; (4, 1)])

    kf
end

function kalman(n)
    reduce((kf, i) -&gt; ocompose(kalman_step(i), 1, kf), 2:n; init=kalman_step(1))
end

to_graphviz(kalman(5), box_labels=:name; implicit_junctions=true)</code></pre><img src='data:image/svg+xml;utf-8,<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: G Pages: 1 -->
<svg width="439pt" height="344pt"
 viewBox="0.00 0.00 439.29 344.23" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 340.23)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-340.23 435.29,-340.23 435.29,4 -4,4"/>
<!-- n1 -->
<g id="box1" class="node">
<title>n1</title>
<ellipse fill="none" stroke="black" cx="61.92" cy="-146.97" rx="26.48" ry="18"/>
<text text-anchor="middle" x="61.92" y="-143.27" font-family="Serif" font-size="14.00">state</text>
</g>
<!-- n22 -->
<!-- junction -->
<g id="junction10" class="node">
<title>n22</title>
<ellipse fill="black" stroke="black" cx="84.92" cy="-113.62" rx="2.5" ry="2.5"/>
</g>
<!-- n1&%2345;&%2345;n22 -->
<g id="edge18" class="edge">
<title>n1&%2345;&%2345;n22</title>
<path fill="none" stroke="black" d="M73.42,-130.29C77.37,-124.56 81.32,-118.83 83.41,-115.81"/>
</g>
<!-- n2 -->
<g id="box2" class="node">
<title>n2</title>
<ellipse fill="none" stroke="black" cx="125.46" cy="-109.81" rx="35.14" ry="18"/>
<text text-anchor="middle" x="125.46" y="-106.11" font-family="Serif" font-size="14.00">predict</text>
</g>
<!-- n21 -->
<!-- junction -->
<g id="junction8" class="node">
<title>n21</title>
<ellipse fill="black" stroke="black" cx="165.87" cy="-99.66" rx="2.5" ry="2.5"/>
</g>
<!-- n2&%2345;&%2345;n21 -->
<g id="edge14" class="edge">
<title>n2&%2345;&%2345;n21</title>
<path fill="none" stroke="black" d="M157.3,-101.81C159.64,-101.22 161.67,-100.71 163.17,-100.34"/>
</g>
<!-- n2&%2345;&%2345;n22 -->
<g id="edge19" class="edge">
<title>n2&%2345;&%2345;n22</title>
<path fill="none" stroke="black" d="M90.55,-113.09C89.49,-113.19 88.54,-113.28 87.74,-113.36"/>
</g>
<!-- n3 -->
<g id="box3" class="node">
<title>n3</title>
<ellipse fill="none" stroke="black" cx="53.46" cy="-88.56" rx="41.41" ry="18"/>
<text text-anchor="middle" x="53.46" y="-84.86" font-family="Serif" font-size="14.00">measure</text>
</g>
<!-- n4 -->
<g id="box4" class="node">
<title>n4</title>
<ellipse fill="none" stroke="black" cx="18" cy="-75.56" rx="18" ry="18"/>
<text text-anchor="middle" x="18" y="-71.86" font-family="Serif" font-size="14.00">z1</text>
</g>
<!-- n3&%2345;&%2345;n4 -->
<g id="edge21" class="edge">
<title>n3&%2345;&%2345;n4</title>
<path fill="none" stroke="black" d="M21.8,-76.95C21.65,-76.9 21.51,-76.85 21.37,-76.79"/>
</g>
<!-- n3&%2345;&%2345;n22 -->
<g id="edge20" class="edge">
<title>n3&%2345;&%2345;n22</title>
<path fill="none" stroke="black" d="M73.56,-104.58C77.41,-107.65 80.89,-110.41 82.95,-112.06"/>
</g>
<!-- n5 -->
<g id="box5" class="node">
<title>n5</title>
<ellipse fill="none" stroke="black" cx="200.88" cy="-122.88" rx="35.14" ry="18"/>
<text text-anchor="middle" x="200.88" y="-119.18" font-family="Serif" font-size="14.00">predict</text>
</g>
<!-- n20 -->
<!-- junction -->
<g id="junction6" class="node">
<title>n20</title>
<ellipse fill="black" stroke="black" cx="240.7" cy="-136.81" rx="2.5" ry="2.5"/>
</g>
<!-- n5&%2345;&%2345;n20 -->
<g id="edge10" class="edge">
<title>n5&%2345;&%2345;n20</title>
<path fill="none" stroke="black" d="M230.24,-133.15C233.41,-134.26 236.16,-135.22 238.05,-135.88"/>
</g>
<!-- n5&%2345;&%2345;n21 -->
<g id="edge15" class="edge">
<title>n5&%2345;&%2345;n21</title>
<path fill="none" stroke="black" d="M179.3,-108.57C174.8,-105.58 170.68,-102.85 168.22,-101.22"/>
</g>
<!-- n6 -->
<g id="box6" class="node">
<title>n6</title>
<ellipse fill="none" stroke="black" cx="168.83" cy="-57.5" rx="41.41" ry="18"/>
<text text-anchor="middle" x="168.83" y="-53.8" font-family="Serif" font-size="14.00">measure</text>
</g>
<!-- n7 -->
<g id="box7" class="node">
<title>n7</title>
<ellipse fill="none" stroke="black" cx="169.55" cy="-18" rx="18" ry="18"/>
<text text-anchor="middle" x="169.55" y="-14.3" font-family="Serif" font-size="14.00">z2</text>
</g>
<!-- n6&%2345;&%2345;n7 -->
<g id="edge17" class="edge">
<title>n6&%2345;&%2345;n7</title>
<path fill="none" stroke="black" d="M169.16,-39.14C169.18,-38.17 169.2,-37.2 169.22,-36.23"/>
</g>
<!-- n6&%2345;&%2345;n21 -->
<g id="edge16" class="edge">
<title>n6&%2345;&%2345;n21</title>
<path fill="none" stroke="black" d="M167.55,-75.63C166.98,-83.84 166.36,-92.66 166.05,-96.97"/>
</g>
<!-- n8 -->
<g id="box8" class="node">
<title>n8</title>
<ellipse fill="none" stroke="black" cx="258.34" cy="-175.09" rx="35.14" ry="18"/>
<text text-anchor="middle" x="258.34" y="-171.39" font-family="Serif" font-size="14.00">predict</text>
</g>
<!-- n19 -->
<!-- junction -->
<g id="junction4" class="node">
<title>n19</title>
<ellipse fill="black" stroke="black" cx="277.55" cy="-212.54" rx="2.5" ry="2.5"/>
</g>
<!-- n8&%2345;&%2345;n19 -->
<g id="edge6" class="edge">
<title>n8&%2345;&%2345;n19</title>
<path fill="none" stroke="black" d="M267.5,-192.94C270.9,-199.57 274.38,-206.35 276.22,-209.94"/>
</g>
<!-- n8&%2345;&%2345;n20 -->
<g id="edge11" class="edge">
<title>n8&%2345;&%2345;n20</title>
<path fill="none" stroke="black" d="M250.14,-157.29C246.97,-150.42 243.7,-143.31 241.96,-139.54"/>
</g>
<!-- n9 -->
<g id="box9" class="node">
<title>n9</title>
<ellipse fill="none" stroke="black" cx="268.42" cy="-104.81" rx="41.41" ry="18"/>
<text text-anchor="middle" x="268.42" y="-101.11" font-family="Serif" font-size="14.00">measure</text>
</g>
<!-- n10 -->
<g id="box10" class="node">
<title>n10</title>
<ellipse fill="none" stroke="black" cx="292.95" cy="-73.41" rx="18" ry="18"/>
<text text-anchor="middle" x="292.95" y="-69.71" font-family="Serif" font-size="14.00">z3</text>
</g>
<!-- n9&%2345;&%2345;n10 -->
<g id="edge13" class="edge">
<title>n9&%2345;&%2345;n10</title>
<path fill="none" stroke="black" d="M281.83,-87.64C281.92,-87.53 282.01,-87.41 282.1,-87.3"/>
</g>
<!-- n9&%2345;&%2345;n20 -->
<g id="edge12" class="edge">
<title>n9&%2345;&%2345;n20</title>
<path fill="none" stroke="black" d="M253.59,-121.93C249.06,-127.16 244.66,-132.23 242.36,-134.89"/>
</g>
<!-- n11 -->
<g id="box11" class="node">
<title>n11</title>
<ellipse fill="none" stroke="black" cx="318.04" cy="-223.64" rx="35.14" ry="18"/>
<text text-anchor="middle" x="318.04" y="-219.94" font-family="Serif" font-size="14.00">predict</text>
</g>
<!-- n18 -->
<!-- junction -->
<g id="junction2" class="node">
<title>n18</title>
<ellipse fill="black" stroke="black" cx="355.14" cy="-241.92" rx="2.5" ry="2.5"/>
</g>
<!-- n11&%2345;&%2345;n18 -->
<g id="edge2" class="edge">
<title>n11&%2345;&%2345;n18</title>
<path fill="none" stroke="black" d="M343.81,-236.34C347.37,-238.09 350.51,-239.64 352.58,-240.66"/>
</g>
<!-- n11&%2345;&%2345;n19 -->
<g id="edge7" class="edge">
<title>n11&%2345;&%2345;n19</title>
<path fill="none" stroke="black" d="M286.54,-215C283.92,-214.29 281.68,-213.67 280.08,-213.23"/>
</g>
<!-- n12 -->
<g id="box12" class="node">
<title>n12</title>
<ellipse fill="none" stroke="black" cx="254.1" cy="-247.41" rx="41.41" ry="18"/>
<text text-anchor="middle" x="254.1" y="-243.71" font-family="Serif" font-size="14.00">measure</text>
</g>
<!-- n13 -->
<g id="box13" class="node">
<title>n13</title>
<ellipse fill="none" stroke="black" cx="235.93" cy="-282.56" rx="18" ry="18"/>
<text text-anchor="middle" x="235.93" y="-278.86" font-family="Serif" font-size="14.00">z4</text>
</g>
<!-- n12&%2345;&%2345;n13 -->
<g id="edge9" class="edge">
<title>n12&%2345;&%2345;n13</title>
<path fill="none" stroke="black" d="M245.01,-264.98C244.8,-265.4 244.59,-265.81 244.38,-266.22"/>
</g>
<!-- n12&%2345;&%2345;n19 -->
<g id="edge8" class="edge">
<title>n12&%2345;&%2345;n19</title>
<path fill="none" stroke="black" d="M265.82,-229.98C269.86,-223.98 273.89,-217.99 276.01,-214.83"/>
</g>
<!-- n14 -->
<g id="box14" class="node">
<title>n14</title>
<ellipse fill="none" stroke="black" cx="392.9" cy="-225.94" rx="35.14" ry="18"/>
<text text-anchor="middle" x="392.9" y="-222.24" font-family="Serif" font-size="14.00">predict</text>
</g>
<!-- n17 -->
<!-- n14&%2345;&%2345;n17 -->
<g id="edge1" class="edge">
<title>n14&%2345;&%2345;n17</title>
<path fill="none" stroke="black" d="M426.45,-220.16C428.11,-219.88 429.39,-219.66 430.12,-219.53"/>
</g>
<!-- n14&%2345;&%2345;n18 -->
<g id="edge3" class="edge">
<title>n14&%2345;&%2345;n18</title>
<path fill="none" stroke="black" d="M365.46,-237.56C362.16,-238.95 359.31,-240.16 357.45,-240.95"/>
</g>
<!-- n15 -->
<g id="box15" class="node">
<title>n15</title>
<ellipse fill="none" stroke="black" cx="363.54" cy="-282.27" rx="41.41" ry="18"/>
<text text-anchor="middle" x="363.54" y="-278.57" font-family="Serif" font-size="14.00">measure</text>
</g>
<!-- n16 -->
<g id="box16" class="node">
<title>n16</title>
<ellipse fill="none" stroke="black" cx="377.19" cy="-318.23" rx="18" ry="18"/>
<text text-anchor="middle" x="377.19" y="-314.53" font-family="Serif" font-size="14.00">z5</text>
</g>
<!-- n15&%2345;&%2345;n16 -->
<g id="edge5" class="edge">
<title>n15&%2345;&%2345;n16</title>
<path fill="none" stroke="black" d="M370.37,-300.25C370.47,-300.53 370.58,-300.81 370.68,-301.09"/>
</g>
<!-- n15&%2345;&%2345;n18 -->
<g id="edge4" class="edge">
<title>n15&%2345;&%2345;n18</title>
<path fill="none" stroke="black" d="M359.74,-263.99C358.17,-256.48 356.54,-248.62 355.7,-244.62"/>
</g>
</g>
</svg>
'/><p>We generate <span>$100$</span> points of data and solve the filtering problem.</p><pre><code class="language-julia hljs">n = 100; kf = kalman(n); data = generate_data(n)

evidence = Dict(&quot;z$i&quot; =&gt; normal(data[i], Zeros(2, 2)) for i in 1:n)

hom_map = Dict(
    evidence...,
    &quot;state&quot; =&gt; normal(Zeros(2), 100I(2)),
    &quot;predict&quot; =&gt; kernel(A, Zeros(2), P),
    &quot;measure&quot; =&gt; kernel(B, Zeros(2), Q))

ob_map = Dict(
    &quot;X&quot; =&gt; 2,
    &quot;Z&quot; =&gt; 2)

ob_attr = :junction_type

mean(oapply(kf, hom_map, ob_map; ob_attr))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{Float64}:
 -0.862475268414081
  0.7601794741583641</code></pre><pre><code class="language-julia hljs">@benchmark oapply(kf, hom_map, ob_map; ob_attr)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 3 samples with 1 evaluation.
 Range (min … max):  2.374 s …  2.385 s  ┊ GC (min … max): 3.95% … 3.91%
 Time  (median):     2.384 s             ┊ GC (median):    3.94%
 Time  (mean ± σ):   2.381 s ± 6.150 ms  ┊ GC (mean ± σ):  3.94% ± 0.02%

  █                                               █      █  
  █▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁█▁▁▁▁▁▁█ ▁
  2.37 s        Histogram: frequency by time        2.39 s &lt;

 Memory estimate: 1.53 GiB, allocs estimate: 23542.</code></pre><p>Since the filtering problem is large, we may wish to solve it using belief propagation.</p><pre><code class="language-julia hljs">T₁ = DenseGaussianSystem{Float64}
T₂ = Int
T₃ = Float64

ip = InferenceProblem{T₁, T₂, T₃}(kf, hom_map, ob_map; ob_attr)
is = init(ip, MinFill())

mean(solve(is))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{Float64}:
 -0.862475268414327
  0.7601794741586002</code></pre><pre><code class="language-julia hljs">@benchmark solve(is)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 972 samples with 1 evaluation.
 Range (min … max):  3.975 ms … 15.926 ms  ┊ GC (min … max):  0.00% … 52.59%
 Time  (median):     4.300 ms              ┊ GC (median):     0.00%
 Time  (mean ± σ):   5.135 ms ±  2.569 ms  ┊ GC (mean ± σ):  15.64% ± 19.05%

   ██▁                                                    ▂▂  
  ▆███▁▄▅▅▁▁▅▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▄▁███ ▇
  3.97 ms      Histogram: log(frequency) by time     13.2 ms &lt;

 Memory estimate: 4.18 MiB, allocs estimate: 46860.</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../regression/">« Linear Regression</a><a class="docs-footer-nextpage" href="../../api/">Library Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Friday 25 August 2023 17:13">Friday 25 August 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
